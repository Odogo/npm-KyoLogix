name: Compatibility (ESM + CJS)

on:
  push:
  pull_request:

jobs:
  compat:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22, 24]
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Pack library
        run: |
          TAR=$(npm pack --silent)
          echo "TARBALL=$TAR" >> $GITHUB_ENV
      
      - name: Verify packed files exist 
        run: |
          tar -tf "${{ env.TARBALL }}" | sed -n '1,120p'
          tar -tf "${{ env.TARBALL }}" | grep -q "package/dist/" || (echo "dist missing from package" && exit 1)

      - name: Test CJS consumer
        run: |
          mkdir -p /tmp/consumer-cjs
          cd /tmp/consumer-cjs
          npm init -y >/dev/null
          npm i --silent "$GITHUB_WORKSPACE/${{ env.TARBALL }}"
          cp "$GITHUB_WORKSPACE/tests/consumers/cjs/index.cjs" ./index.cjs
          node ./index.cjs

      - name: Test ESM consumer
        run: |
          mkdir -p /tmp/consumer-esm
          cd /tmp/consumer-esm
          npm init -y >/dev/null
          npm i --silent "$GITHUB_WORKSPACE/${{ env.TARBALL }}"
          cp "$GITHUB_WORKSPACE/tests/consumers/esm/index.mjs" ./index.mjs
          node ./index.mjs